<ul id="output"></ul>
<%= javascript_include_tag "d3statement" %>

<%= javascript_tag do %>
  var data_source = <%= session["data"].to_json.html_safe %>;
  if (!data_source) { data_source = [] }

  for(var i in data_source){
    $("#output").append("<li>" + data_source[i].ticker + "</li>");
  }

  var dataset = []
  var done = 0;
  for (var i in data_source){
    JHR(data_source[i].ticker + "/year/" + data_source[i].year + "?timestamp=" + data_source[i].timestamp, "GET", [], 
    function(response, xhr){
      dataset.push(response);
      done = done + 1;
      if(done == data_source.length){
        dataset.sort(function(a,b){ 
          if(a.timestamp < b.timestamp) return -1;
          if(a.timestamp > b.timestamp) return 1;
          return 0;
        })
        appendData();
      }
    });
  }
<% end %>
